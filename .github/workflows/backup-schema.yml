name: Backup Supabase Schema

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/backup-schema.yml'

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Debug - Show everything
        run: |
          echo "=== Current directory ==="
          pwd
          echo ""
          echo "=== List current directory ==="
          ls -la
          echo ""
          echo "=== Does database/ exist? ==="
          ls -la database/ || echo "database/ does not exist"
          echo ""
          echo "=== Does database/backups/ exist? ==="
          ls -la database/backups/ || echo "database/backups/ does not exist"
          echo ""
          echo "=== Creating database/backups/ ==="
          mkdir -p database/backups
          echo ""
          echo "=== After mkdir, does it exist? ==="
          ls -la database/backups/
          echo ""
          echo "=== Can we write to it? ==="
          echo "test" > database/backups/test.txt
          cat database/backups/test.txt
          echo "âœ… Write test successful!"
          
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          
      - name: Backup Database Schema
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "Starting backup..."
          PGPASSWORD=$SUPABASE_DB_PASSWORD pg_dump \
            -h db.${SUPABASE_PROJECT_ID}.supabase.co \
            -p 5432 \
            -U postgres \
            -d postgres \
            --schema-only \
            --schema=public \
            --no-owner \
            --no-privileges \
            -f database/backups/schema_backup_$(date +%Y%m%d).sql
          echo "Backup completed!"
          ls -la database/backups/
